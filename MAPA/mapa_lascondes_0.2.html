<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mapa Integrado â€” Las Condes</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap');
  
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'DM Sans',system-ui,sans-serif; background:#0f1117; color:#e2e4e9; height:100vh; overflow:hidden; }
  
  #map { position:absolute; inset:0; z-index:1; }
  
  /* â•â•â• PANEL ÃšLTIMA HORA â•â•â• */
  #panel {
    position:fixed; top:0; right:0; width:340px; height:100vh; z-index:1000;
    background:rgba(15,17,23,.92); backdrop-filter:blur(16px);
    border-left:1px solid rgba(255,255,255,.08);
    display:flex; flex-direction:column;
    transition:transform .3s cubic-bezier(.4,0,.2,1);
  }
  #panel.collapsed { transform:translateX(100%); }
  
  #panel-toggle {
    position:fixed; top:12px; right:352px; z-index:1001;
    background:rgba(15,17,23,.85); backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.1); color:#e2e4e9;
    padding:8px 12px; border-radius:8px; cursor:pointer;
    font:600 12px 'DM Sans',sans-serif; letter-spacing:.3px;
    transition:all .3s;
  }
  #panel-toggle:hover { background:rgba(37,99,235,.3); border-color:rgba(37,99,235,.5); }
  #panel.collapsed ~ #panel-toggle { right:12px; }
  
  #panel-header {
    padding:14px 16px 10px; border-bottom:1px solid rgba(255,255,255,.06);
    flex-shrink:0;
  }
  #panel-header h2 {
    font-size:14px; font-weight:700; color:#fff;
    display:flex; align-items:center; gap:8px;
  }
  #panel-header h2 .badge {
    background:rgba(37,99,235,.25); color:#60a5fa;
    padding:2px 8px; border-radius:10px; font-size:11px; font-weight:600;
  }
  #status-bar {
    display:flex; gap:12px; margin-top:6px; font-size:11px; color:rgba(255,255,255,.5);
  }
  #status-bar span { display:flex; align-items:center; gap:4px; }
  .dot { width:7px; height:7px; border-radius:50%; display:inline-block; }
  .dot.pend { background:#f87171; } .dot.cerr { background:#60a5fa; }
  
  #panel-filters {
    padding:8px 16px; display:flex; gap:6px; flex-wrap:wrap;
    border-bottom:1px solid rgba(255,255,255,.06); flex-shrink:0;
  }
  .filter-btn {
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    color:rgba(255,255,255,.6); padding:3px 10px; border-radius:6px;
    font:500 10px 'DM Sans',sans-serif; cursor:pointer; transition:all .2s;
    text-transform:uppercase; letter-spacing:.4px;
  }
  .filter-btn:hover { background:rgba(255,255,255,.1); color:#fff; }
  .filter-btn.active { background:rgba(37,99,235,.2); border-color:rgba(37,99,235,.4); color:#60a5fa; }
  
  #panel-body { flex:1; overflow-y:auto; padding:4px 0; }
  #panel-body::-webkit-scrollbar { width:4px; }
  #panel-body::-webkit-scrollbar-thumb { background:rgba(255,255,255,.15); border-radius:2px; }
  
  .section-header {
    padding:6px 16px; font-size:10px; font-weight:700; text-transform:uppercase;
    letter-spacing:.8px; color:rgba(255,255,255,.35); background:rgba(255,255,255,.02);
    position:sticky; top:0; z-index:2;
  }
  
  .proc-card {
    padding:10px 16px; border-bottom:1px solid rgba(255,255,255,.04);
    cursor:pointer; transition:background .15s;
  }
  .proc-card:hover { background:rgba(255,255,255,.04); }
  .proc-card.highlight { animation:flash .8s ease 2; }
  @keyframes flash { 0%,100%{background:transparent} 50%{background:rgba(251,191,36,.12)} }
  
  .proc-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:4px; }
  .proc-tipo { font-size:12px; font-weight:600; color:#fff; }
  .proc-estado {
    font-size:9px; font-weight:700; padding:2px 6px; border-radius:4px;
    text-transform:uppercase; letter-spacing:.3px;
  }
  .proc-estado.pendiente { background:rgba(239,68,68,.15); color:#f87171; }
  .proc-estado.cerrado { background:rgba(96,165,250,.12); color:#60a5fa; }
  
  .proc-meta { font-size:10px; color:rgba(255,255,255,.4); display:flex; gap:8px; margin-bottom:3px; }
  .proc-dir { font-size:11px; color:rgba(255,255,255,.6); }
  
  .proc-actions { display:flex; gap:4px; margin-top:5px; }
  .proc-actions button {
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    color:rgba(255,255,255,.5); padding:2px 8px; border-radius:4px;
    font:500 9px 'DM Sans',sans-serif; cursor:pointer; transition:all .15s;
  }
  .proc-actions button:hover { background:rgba(37,99,235,.2); color:#60a5fa; border-color:rgba(37,99,235,.3); }
  
  /* Category colors for left border */
  .proc-card.cat-robo { border-left:3px solid #ef4444; }
  .proc-card.cat-accidente { border-left:3px solid #f59e0b; }
  .proc-card.cat-salud { border-left:3px solid #10b981; }
  .proc-card.cat-sospechoso { border-left:3px solid #8b5cf6; }
  .proc-card.cat-infraestructura { border-left:3px solid #06b6d4; }
  .proc-card.cat-orden { border-left:3px solid #ec4899; }
  .proc-card.cat-otro { border-left:3px solid rgba(255,255,255,.15); }
  
  /* â•â•â• BARRA ESTADO INFERIOR â•â•â• */
  #bottom-bar {
    position:fixed; bottom:0; left:0; right:340px; z-index:999;
    background:rgba(15,17,23,.88); backdrop-filter:blur(8px);
    border-top:1px solid rgba(255,255,255,.06);
    padding:6px 16px; display:flex; justify-content:space-between;
    align-items:center; font-size:11px; color:rgba(255,255,255,.5);
    transition:right .3s;
  }
  #panel.collapsed ~ #bottom-bar { right:0; }
  #clock { font-weight:600; color:rgba(255,255,255,.7); font-variant-numeric:tabular-nums; }
  #refresh-indicator { display:flex; align-items:center; gap:6px; }
  #countdown { 
    font-weight:600; color:#60a5fa; font-variant-numeric:tabular-nums;
    min-width:20px; text-align:right;
  }
  .spinner { 
    width:10px; height:10px; border:2px solid rgba(96,165,250,.3);
    border-top-color:#60a5fa; border-radius:50%; display:none;
    animation:spin .6s linear infinite;
  }
  .spinner.active { display:inline-block; }
  @keyframes spin { to{transform:rotate(360deg)} }
  
  #cam-count { color:rgba(255,255,255,.35); }
  
  /* â•â•â• LEYENDA DE CÃMARAS â•â•â• */
  #legend {
    position:fixed; bottom:40px; left:12px; z-index:999;
    background:rgba(15,17,23,.85); backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.08); border-radius:8px;
    padding:8px 12px; font-size:10px;
  }
  #legend h4 { font-size:10px; font-weight:600; color:rgba(255,255,255,.5); margin-bottom:4px; text-transform:uppercase; letter-spacing:.5px; }
  .legend-item { display:flex; align-items:center; gap:6px; margin:2px 0; color:rgba(255,255,255,.5); }
  .legend-dot { width:8px; height:8px; border-radius:50%; }
  
  /* â•â•â• MAP POPUP â•â•â• */
  .leaflet-popup-content-wrapper {
    background:rgba(15,17,23,.95) !important; backdrop-filter:blur(12px);
    border:1px solid rgba(255,255,255,.1) !important; border-radius:8px !important;
    color:#e2e4e9 !important; box-shadow:0 8px 32px rgba(0,0,0,.5) !important;
  }
  .leaflet-popup-tip { background:rgba(15,17,23,.95) !important; border:1px solid rgba(255,255,255,.1) !important; }
  .leaflet-popup-content { margin:10px 14px !important; font-family:'DM Sans',sans-serif !important; font-size:12px !important; }
  .popup-tipo { font-weight:700; font-size:13px; margin-bottom:4px; }
  .popup-dir { color:rgba(255,255,255,.6); font-size:11px; margin-bottom:6px; }
  .popup-meta { font-size:10px; color:rgba(255,255,255,.4); }
  
  /* Camera popup */
  .cam-popup .leaflet-popup-content-wrapper { border-color:rgba(6,182,212,.3) !important; }

  /* Mode indicator */
  #mode-indicator {
    position:fixed; top:12px; left:12px; z-index:999;
    background:rgba(15,17,23,.85); backdrop-filter:blur(8px);
    border:1px solid rgba(255,255,255,.08); border-radius:8px;
    padding:8px 14px; font-size:11px; color:rgba(255,255,255,.5);
    display:flex; align-items:center; gap:6px;
  }
  #mode-indicator .live-dot {
    width:6px; height:6px; border-radius:50%; background:#10b981;
    animation:pulse-live 2s ease infinite;
  }
  #mode-indicator.demo .live-dot { background:#f59e0b; animation:none; }
  @keyframes pulse-live { 0%,100%{opacity:1} 50%{opacity:.3} }
</style>
</head>
<body>

<div id="map"></div>

<div id="mode-indicator">
  <span class="live-dot"></span>
  <span id="mode-text">Conectando...</span>
</div>

<div id="panel">
  <div id="panel-header">
    <h2>
      â° Ãšltima Hora
      <span class="badge" id="proc-count">0</span>
    </h2>
    <div id="status-bar">
      <span><span class="dot pend"></span> Pendientes: <strong id="cnt-pend">0</strong></span>
      <span><span class="dot cerr"></span> Cerrados: <strong id="cnt-cerr">0</strong></span>
    </div>
  </div>
  <div id="panel-filters">
    <button class="filter-btn active" data-cat="all">Todos</button>
    <button class="filter-btn" data-cat="robo">ğŸ”´ Robos</button>
    <button class="filter-btn" data-cat="accidente">ğŸŸ¡ Accidentes</button>
    <button class="filter-btn" data-cat="salud">ğŸŸ¢ Salud</button>
    <button class="filter-btn" data-cat="sospechoso">ğŸŸ£ Sospechosos</button>
    <button class="filter-btn" data-cat="infraestructura">ğŸ”µ Infraestr.</button>
  </div>
  <div id="panel-body"></div>
</div>

<button id="panel-toggle" onclick="togglePanel()">â—€ Panel</button>

<div id="bottom-bar">
  <span id="cam-count">CÃ¡maras: cargando...</span>
  <div id="refresh-indicator">
    <span class="spinner" id="spinner"></span>
    <span>Refresh: <strong id="countdown">--</strong>s</span>
  </div>
  <span id="clock">--:--:--</span>
</div>

<div id="legend">
  <h4>Procedimientos</h4>
  <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span> Robos</div>
  <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span> Accidentes</div>
  <div class="legend-item"><span class="legend-dot" style="background:#10b981"></span> Salud</div>
  <div class="legend-item"><span class="legend-dot" style="background:#8b5cf6"></span> Sospechosos</div>
  <div class="legend-item"><span class="legend-dot" style="background:#06b6d4"></span> CÃ¡maras</div>
</div>

<script>
(function(){
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIGURACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONFIG = {
  CENTER: [-33.4050, -70.5670],
  ZOOM: 14,
  // URL del sistema de procedimientos
  PROC_URL: 'https://seguridad.lascondes.cl/incidents',
  // ArcGIS visor URL
  ARCGIS_URL: 'https://arcgismlc.lascondes.cl/portal/apps/webappviewer/index.html?id=118513d990134fcbb9196ac7884cfb8c',
  // Refresh intervals (seconds) based on pending count
  REFRESH: { 0: 30, 5: 15, 15: 8, max: 5 },
  // Hora de ventana (60 min)
  VENTANA_MIN: 60,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CATEGORÃAS (misma fuente que Sistema MÃ¡scara)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CATEGORIAS = [
  { id:'robo', nombre:'Robos', color:'#ef4444', keywords: [
    'robo','hurto','asalto','portonazo','encerronas','intimidaciÃ³n','sustracciÃ³n'
  ]},
  { id:'accidente', nombre:'Accidentes', color:'#f59e0b', keywords: [
    'colisiÃ³n','choque','atropello','accidente','volcamiento','caÃ­da en vehÃ­culo'
  ]},
  { id:'salud', nombre:'Salud', color:'#10b981', keywords: [
    'lesionado','persona desmayada','parturienta','suicidio','salud','oxÃ­geno','paramÃ©dico'
  ]},
  { id:'sospechoso', nombre:'Sospechosos', color:'#8b5cf6', keywords: [
    'sospechoso','merodeo','detecciÃ³n de vehÃ­culo','encargo','hallazgo','lector ppu'
  ]},
  { id:'infraestructura', nombre:'Infraestructura', color:'#06b6d4', keywords: [
    'semÃ¡foro','luminaria','hoyo','hundimiento','grifo','sumidero','tapa cÃ¡mara',
    'cables cortados','corte de energÃ­a','corte de agua','desganche','Ã¡rbol',
    'material de arrastre','poste chocado','reja de plaza'
  ]},
  { id:'orden', nombre:'Orden PÃºblico', color:'#ec4899', keywords: [
    'riÃ±a','pendencia','ruidos molestos','consumo de cannabis','huelga','manifestaciÃ³n',
    'comercio ambulante','limpia vidrios'
  ]},
];

function clasificar(tipo) {
  if (!tipo) return { id:'otro', nombre:'Otro', color:'rgba(255,255,255,.3)' };
  const t = tipo.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
  for (const cat of CATEGORIAS) {
    for (const kw of cat.keywords) {
      const k = kw.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      if (t.includes(k)) return cat;
    }
  }
  return { id:'otro', nombre:'Otro', color:'rgba(255,255,255,.3)' };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROCEDIMIENTOS DEMO (datos reales del snapshot)
// Usados cuando no hay acceso al servidor
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEMO_PROCS = [
  {fecha:'04/02/2026 16:10',tipo:'Corte de energÃ­a elÃ©ctrica o similar',id:'3410726',dir:'APOQUINDO, 3401',estado:'PENDIENTE',desc:'#10506480',operador:'SSLC'},
  {fecha:'04/02/2026 16:08',tipo:'Material de Arrastre',id:'3410725',dir:'VITAL APOQUINDO (MARISOL)',estado:'PENDIENTE',desc:'CamiÃ³n cargado con barro',operador:'SSLC'},
  {fecha:'04/02/2026 16:06',tipo:'Perro Suelto',id:'3410724',dir:'CERRO PINTOR, 1318',estado:'CERRADO',desc:'Sosafe 10506462',operador:'SSLC'},
  {fecha:'04/02/2026 16:03',tipo:'Reporte Puntos Fijos',id:'HRUTA-235548',dir:'CAMINO MIRASOL, 2373 (QUEBRADA HONDA)',estado:'PENDIENTE',desc:'Punto fijo cerrar calle por trabajos',operador:''},
  {fecha:'04/02/2026 16:03',tipo:'Reporte Destacamentos',id:'3410723',dir:'QUINCHAMALI, 14182',estado:'PENDIENTE',desc:'Destacamento Quinchamali',operador:'SSLC'},
  {fecha:'04/02/2026 16:01',tipo:'VehÃ­culos Mal Estacionados',id:'3410722',dir:'LA CASTELLANA SUR, 98',estado:'PENDIENTE',desc:'VehÃ­culos mal estacionados en ambos lados',operador:'SSLC'},
  {fecha:'04/02/2026 16:00',tipo:'Consultas en General',id:'3410721',dir:'PATAGONIA, 29',estado:'CERRADO',desc:'Solicita nÃºmero telefÃ³nico',operador:'SSLC'},
  {fecha:'04/02/2026 15:59',tipo:'Consultas en General',id:'3410720',dir:'VIA LACTEA, 9235',estado:'CERRADO',desc:'Solicita nÃºmeros de parques y jardines',operador:'SSLC'},
  {fecha:'04/02/2026 15:57',tipo:'BotÃ³n de PÃ¡nico',id:'3410719',dir:'LOS TROYANOS 939',estado:'PENDIENTE',desc:'ActivaciÃ³n BotÃ³n de PÃ¡nico',operador:'CECOCO'},
  {fecha:'04/02/2026 15:56',tipo:'RepeticiÃ³n de Servicio',id:'3410718',dir:'CERRO COLORADO, 6130',estado:'CERRADO',desc:'Relacionado S-3410666 Desorden',operador:'SSLC'},
  {fecha:'04/02/2026 15:55',tipo:'Consultas en General',id:'3410717',dir:'VASCO DE GAMA, 4477',estado:'CERRADO',desc:'Consulta nÃºmero aseo y ornato',operador:'SSLC'},
  {fecha:'04/02/2026 15:54',tipo:'BotÃ³n de PÃ¡nico',id:'3410716',dir:'RIO GUADIANA 8768',estado:'PENDIENTE',desc:'ActivaciÃ³n BotÃ³n de PÃ¡nico',operador:'CECOCO'},
  {fecha:'04/02/2026 15:53',tipo:'Reclamo por Maltrato Animal',id:'3410715',dir:'COMANDANTE BELISARIO FRITZ (LA CAPITANIA)',estado:'PENDIENTE',desc:'Perrito que llora todo el dÃ­a',operador:'SSLC'},
  {fecha:'04/02/2026 15:52',tipo:'Desganche o Ã¡rbol derribado',id:'3410714',dir:'NEVERIA (JORGE VI)',estado:'PENDIENTE',desc:'Rama de Ã¡rbol muy baja obstruye paso',operador:'SSLC'},
  {fecha:'04/02/2026 15:50',tipo:'Sospechoso en VÃ­a PÃºblica',id:'3410712',dir:'LOS POZOS (CUARTO CENTENARIO)',estado:'PENDIENTE',desc:'Sosafe 10506388',operador:'SSLC - SOSAFE'},
  {fecha:'04/02/2026 15:48',tipo:'VehÃ­culos Mal Estacionados',id:'3410710',dir:'PLAZA, 2204',estado:'PENDIENTE',desc:'Buses Romanini frente a la direcciÃ³n',operador:'SSLC'},
  {fecha:'04/02/2026 15:45',tipo:'DetecciÃ³n de VehÃ­culo con Sistema Lector PPU',id:'3410708',dir:'245 MANQUEHUE . BILBAO / LPR 1',estado:'PENDIENTE',desc:'Lista de InterÃ©s encargos',operador:'CECOCO'},
  {fecha:'04/02/2026 15:43',tipo:'LLamada falsa',id:'3410707',dir:'QUINCHAMALI, 14173',estado:'CERRADO',desc:'Sosafe reporte eliminado por autor',operador:'SSLC - SOSAFE'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEOCODING (direcciones Las Condes conocidas)
// Lookup estÃ¡tico para evitar dependencia de Nominatim
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEOCODE_CACHE = {
  'APOQUINDO, 3401': [-33.4178, -70.5985],
  'VITAL APOQUINDO': [-33.4210, -70.5880],
  'CERRO PINTOR, 1318': [-33.3830, -70.5250],
  'CAMINO MIRASOL, 2373': [-33.3680, -70.5050],
  'QUINCHAMALI, 14182': [-33.4260, -70.5420],
  'QUINCHAMALI, 14173': [-33.4258, -70.5418],
  'LA CASTELLANA SUR, 98': [-33.4090, -70.5760],
  'PATAGONIA, 29': [-33.4120, -70.5500],
  'VIA LACTEA, 9235': [-33.3750, -70.5200],
  'LOS TROYANOS 939': [-33.4050, -70.5700],
  'CERRO COLORADO, 6130': [-33.4090, -70.5460],
  'VASCO DE GAMA, 4477': [-33.4180, -70.5660],
  'RIO GUADIANA 8768': [-33.3900, -70.5300],
  'COMANDANTE BELISARIO FRITZ': [-33.4200, -70.5750],
  'NEVERIA': [-33.3850, -70.5400],
  'LOS POZOS': [-33.4100, -70.5830],
  'PLAZA, 2204': [-33.4140, -70.5620],
  '245 MANQUEHUE': [-33.4070, -70.5730],
};

function geocode(dir) {
  if (!dir) return null;
  const d = dir.toUpperCase().trim();
  // Direct match
  if (GEOCODE_CACHE[d]) return GEOCODE_CACHE[d];
  // Partial match
  for (const [key, coords] of Object.entries(GEOCODE_CACHE)) {
    if (d.includes(key) || key.includes(d.split(',')[0])) return coords;
  }
  // Fallback: scatter around Las Condes center with deterministic offset
  let hash = 0;
  for (let i = 0; i < d.length; i++) hash = ((hash << 5) - hash) + d.charCodeAt(i);
  const latOff = ((hash % 1000) / 1000) * 0.04 - 0.02;
  const lngOff = (((hash >> 10) % 1000) / 1000) * 0.04 - 0.02;
  return [CONFIG.CENTER[0] + latOff, CONFIG.CENTER[1] + lngOff];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃMARAS (nÃºmeros de destacamentos del ArcGIS snapshot)
// Posiciones basadas en la distribuciÃ³n conocida de Las Condes
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CAMARAS_DESTACAMENTOS = {
  107: {lat:-33.4280, lng:-70.5600, nombre:'Destacamento 107'},
  108: {lat:-33.4200, lng:-70.5850, nombre:'Destacamento 108'},
  109: {lat:-33.4100, lng:-70.5750, nombre:'Destacamento 109'},
  110: {lat:-33.4150, lng:-70.5680, nombre:'Destacamento 110'},
  111: {lat:-33.4050, lng:-70.5620, nombre:'Destacamento 111'},
  112: {lat:-33.4000, lng:-70.5600, nombre:'Destacamento 112'},
  143: {lat:-33.4180, lng:-70.5530, nombre:'Destacamento 143'},
  144: {lat:-33.4200, lng:-70.5420, nombre:'Destacamento 144'},
  145: {lat:-33.3950, lng:-70.5430, nombre:'Destacamento 145'},
  146: {lat:-33.3900, lng:-70.5300, nombre:'Destacamento 146'},
  147: {lat:-33.3750, lng:-70.5200, nombre:'Destacamento 147'},
  148: {lat:-33.4250, lng:-70.5600, nombre:'Destacamento 148'},
  149: {lat:-33.4300, lng:-70.5680, nombre:'Destacamento 149'},
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAPA LEAFLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const map = L.map('map', {
  center: CONFIG.CENTER,
  zoom: CONFIG.ZOOM,
  zoomControl: false,
  attributionControl: false,
});

// TILE LAYER: OpenStreetMap estÃ¡ndar â€” calles legibles, orientaciÃ³n clara
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

L.control.zoom({ position: 'topleft' }).addTo(map);
L.control.attribution({ position: 'bottomleft', prefix: false }).addTo(map);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPA DE CÃMARAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const camarasLayer = L.layerGroup().addTo(map);
let camarasCount = 0;

function renderCamaras() {
  camarasLayer.clearLayers();
  camarasCount = 0;
  
  for (const [num, cam] of Object.entries(CAMARAS_DESTACAMENTOS)) {
    const marker = L.circleMarker([cam.lat, cam.lng], {
      radius: 6,
      fillColor: '#06b6d4',
      fillOpacity: 0.7,
      color: '#0891b2',
      weight: 1.5,
    }).addTo(camarasLayer);
    
    marker.bindPopup(`
      <div class="cam-popup">
        <div class="popup-tipo" style="color:#06b6d4">ğŸ“· ${cam.nombre}</div>
        <div class="popup-meta">CÃ¡mara #${num}</div>
      </div>
    `);
    
    // Label
    L.marker([cam.lat, cam.lng], {
      icon: L.divIcon({
        className: '',
        html: `<div style="font:700 9px 'DM Sans',sans-serif;color:#0891b2;text-shadow:0 0 3px rgba(0,0,0,.7),0 0 6px rgba(0,0,0,.5);white-space:nowrap;transform:translate(-50%,-18px);text-align:center">${num}</div>`,
        iconSize: [0, 0],
      })
    }).addTo(camarasLayer);
    
    camarasCount++;
  }
  
  document.getElementById('cam-count').textContent = `CÃ¡maras: ${camarasCount} destacamentos`;
}

renderCamaras();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CAPA DE PROCEDIMIENTOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const procLayer = L.layerGroup().addTo(map);
const procMarkers = new Map();
let allProcs = [];
let activeFilter = 'all';
let isLive = false;

function renderProcOnMap(proc) {
  const coords = geocode(proc.dir);
  if (!coords) return;
  
  const cat = clasificar(proc.tipo);
  const isPend = proc.estado === 'PENDIENTE';
  
  const marker = L.circleMarker(coords, {
    radius: isPend ? 8 : 5,
    fillColor: cat.color,
    fillOpacity: isPend ? 0.8 : 0.4,
    color: '#fff',
    weight: isPend ? 2 : 1,
  }).addTo(procLayer);
  
  marker.bindPopup(`
    <div>
      <div class="popup-tipo" style="color:${cat.color}">${proc.tipo}</div>
      <div class="popup-dir">ğŸ“ ${proc.dir || 'Sin direcciÃ³n'}</div>
      <div class="popup-meta">
        ${proc.fecha} Â· ID: ${proc.id}<br>
        Estado: <strong style="color:${isPend ? '#f87171' : '#60a5fa'}">${proc.estado}</strong>
      </div>
    </div>
  `);
  
  procMarkers.set(proc.id, { marker, proc, coords });
}

function clearProcLayer() {
  procLayer.clearLayers();
  procMarkers.clear();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPanel() {
  const body = document.getElementById('panel-body');
  
  let filtered = activeFilter === 'all' 
    ? allProcs 
    : allProcs.filter(p => clasificar(p.tipo).id === activeFilter);
  
  const pendientes = filtered.filter(p => p.estado === 'PENDIENTE');
  const cerrados = filtered.filter(p => p.estado === 'CERRADO');
  
  document.getElementById('proc-count').textContent = filtered.length;
  document.getElementById('cnt-pend').textContent = allProcs.filter(p => p.estado === 'PENDIENTE').length;
  document.getElementById('cnt-cerr').textContent = allProcs.filter(p => p.estado === 'CERRADO').length;
  
  let html = '';
  
  if (pendientes.length) {
    html += `<div class="section-header">ğŸ”´ Pendientes (${pendientes.length})</div>`;
    html += pendientes.map(p => renderProcCard(p)).join('');
  }
  
  if (cerrados.length) {
    html += `<div class="section-header">ğŸ”µ Cerrados (${cerrados.length})</div>`;
    html += cerrados.map(p => renderProcCard(p)).join('');
  }
  
  if (!filtered.length) {
    html = '<div style="padding:40px;text-align:center;color:rgba(255,255,255,.3)">Sin procedimientos en esta categorÃ­a</div>';
  }
  
  body.innerHTML = html;
  
  // Bind click events
  body.querySelectorAll('.proc-card').forEach(card => {
    card.addEventListener('click', (e) => {
      if (e.target.closest('button')) return;
      const id = card.dataset.id;
      const entry = procMarkers.get(id);
      if (entry) {
        map.setView(entry.coords, 16, { animate: true });
        entry.marker.openPopup();
      }
    });
  });
  
  body.querySelectorAll('.btn-arcgis').forEach(btn => {
    btn.addEventListener('click', () => {
      const dir = btn.dataset.dir;
      if (dir) {
        const q = dir.replace(/,\s*\d+/, '').replace(/\(.*?\)/g, '').trim();
        const url = `${CONFIG.ARCGIS_URL}&find=${encodeURIComponent(q + ', Las Condes')}`;
        window.open(url, 'arcgis_visor');
      }
    });
  });
  
  body.querySelectorAll('.btn-gmaps').forEach(btn => {
    btn.addEventListener('click', () => {
      const dir = btn.dataset.dir;
      if (dir) {
        const q = dir.replace(/,\s*\d+/, '').replace(/\(.*?\)/g, '').trim() + ', Las Condes, Chile';
        window.open(`https://www.google.com/maps/search/${encodeURIComponent(q)}`, 'gmaps_visor');
      }
    });
  });
  
  // Render on map
  clearProcLayer();
  filtered.forEach(p => renderProcOnMap(p));
}

function renderProcCard(p) {
  const cat = clasificar(p.tipo);
  const isPend = p.estado === 'PENDIENTE';
  const horaMatch = p.fecha.match(/\d{2}:\d{2}/);
  const hora = horaMatch ? horaMatch[0] : p.fecha;
  
  return `
    <div class="proc-card cat-${cat.id}" data-id="${p.id}">
      <div class="proc-top">
        <span class="proc-tipo">${p.tipo}</span>
        <span class="proc-estado ${isPend ? 'pendiente' : 'cerrado'}">${p.estado}</span>
      </div>
      <div class="proc-meta">
        <span>ğŸ• ${hora}</span>
        <span>ID: ${p.id}</span>
      </div>
      <div class="proc-dir">ğŸ“ ${p.dir || 'Sin direcciÃ³n'}</div>
      <div class="proc-actions">
        <button class="btn-arcgis" data-dir="${p.dir}" title="Buscar en ArcGIS">ğŸ—ºï¸ ArcGIS</button>
        <button class="btn-gmaps" data-dir="${p.dir}" title="Buscar en Google Maps">ğŸ“ GMaps</button>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTROS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.cat;
    renderPanel();
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH PROCEDIMIENTOS (real o demo)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function parseProcFromHTML(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const filas = doc.querySelectorAll('table.table tbody tr');
  const resultados = [];
  const ahora = new Date();
  const limite = new Date(ahora.getTime() - CONFIG.VENTANA_MIN * 60000);
  
  filas.forEach(fila => {
    const celdas = fila.querySelectorAll('td');
    if (celdas.length < 7) return;
    
    const fechaTexto = celdas[1]?.textContent?.trim();
    if (!fechaTexto) return;
    
    // Parse DD/MM/YYYY HH:MM
    const m = fechaTexto.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2}):(\d{2})/);
    if (!m) return;
    const fecha = new Date(m[3], m[2]-1, m[1], m[4], m[5]);
    
    // Filter to last hour
    if (fecha < limite) return;
    
    const estado = fila.innerHTML.includes('badge-danger') ? 'PENDIENTE' : 'CERRADO';
    
    resultados.push({
      fecha: fechaTexto,
      tipo: celdas[2]?.textContent?.trim() || '',
      id: celdas[3]?.textContent?.trim() || '',
      operador: celdas[4]?.textContent?.trim() || '',
      desc: celdas[5]?.textContent?.trim()?.substring(0, 100) || '',
      dir: celdas[6]?.textContent?.trim() || '',
      estado: estado,
    });
  });
  
  return resultados;
}

async function fetchProcedimientos() {
  const spinner = document.getElementById('spinner');
  spinner.classList.add('active');
  
  try {
    // Attempt live fetch
    const resp = await fetch(CONFIG.PROC_URL, {
      credentials: 'include',
      headers: { 'Accept': 'text/html' },
    });
    
    if (resp.ok) {
      const html = await resp.text();
      const procs = parseProcFromHTML(html);
      
      if (procs.length > 0) {
        setMode('live');
        allProcs = procs;
        renderPanel();
        spinner.classList.remove('active');
        return;
      }
    }
  } catch(e) {
    console.log('Live fetch failed, using demo data:', e.message);
  }
  
  // Fallback to demo
  setMode('demo');
  allProcs = DEMO_PROCS;
  renderPanel();
  spinner.classList.remove('active');
}

function setMode(mode) {
  const indicator = document.getElementById('mode-indicator');
  const text = document.getElementById('mode-text');
  if (mode === 'live') {
    isLive = true;
    indicator.classList.remove('demo');
    text.textContent = 'En vivo â€” seguridad.lascondes.cl';
  } else {
    isLive = false;
    indicator.classList.add('demo');
    text.textContent = 'Demo â€” datos del snapshot (CORS/auth requerido para live)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REFRESH ADAPTATIVO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let refreshTimer = null;
let countdownVal = 0;

function getRefreshInterval() {
  const pend = allProcs.filter(p => p.estado === 'PENDIENTE').length;
  if (pend === 0) return CONFIG.REFRESH[0];
  if (pend <= 5) return CONFIG.REFRESH[5];
  if (pend <= 15) return CONFIG.REFRESH[15];
  return CONFIG.REFRESH.max;
}

function startRefreshCycle() {
  if (refreshTimer) clearInterval(refreshTimer);
  
  countdownVal = getRefreshInterval();
  document.getElementById('countdown').textContent = countdownVal;
  
  refreshTimer = setInterval(() => {
    countdownVal--;
    document.getElementById('countdown').textContent = Math.max(0, countdownVal);
    
    if (countdownVal <= 0) {
      fetchProcedimientos().then(() => {
        countdownVal = getRefreshInterval();
      });
    }
  }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RELOJ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString('es-CL', { hour12: false });
}
setInterval(updateClock, 1000);
updateClock();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PANEL TOGGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.togglePanel = function() {
  const panel = document.getElementById('panel');
  panel.classList.toggle('collapsed');
  const btn = document.getElementById('panel-toggle');
  btn.textContent = panel.classList.contains('collapsed') ? 'â–¶ Panel' : 'â—€ Panel';
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
fetchProcedimientos().then(() => {
  startRefreshCycle();
});

})();
</script>
</body>
</html>
